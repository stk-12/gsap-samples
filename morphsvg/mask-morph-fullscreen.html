<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Morphing Number Mask</title>
  <style>
    body{
      background:#000;
    }
    .stage{
      position:fixed;
      inset:0;
      overflow:hidden;
      background:#000;
      height: 100vh;
    }
    svg{display:block;width:100%;height:100%}
    .photo{filter:contrast(1.06) saturate(1.05)}
  </style>
</head>
<body>

  <div class="stage">
     <!-- 500×500 の正方形座標系を、画面全体カバーで拡大表示 -->
    <svg viewBox="0 0 500 500" preserveAspectRatio="xMidYMid slice" role="img">
      <defs>
        <mask id="digitMask" maskUnits="userSpaceOnUse">
          <rect width="500" height="500" fill="#000"/>
          <!-- 初期表示 -->
          <g id="maskTranslate">
            <g id="maskScale">
              <path id="digitPath" fill="#fff" d="M192.25,422.75c-16.67-6.33-30.75-15.16-42.25-26.5-11.5-11.33-20.34-24.16-26.5-38.5-6.17-14.33-9.25-29.16-9.25-44.5h83c0,11.34,2.5,20.84,7.5,28.5,5,7.67,11.75,13.34,20.25,17,8.5,3.67,17.41,5.5,26.75,5.5,10,0,18.75-1.5,26.25-4.5s13.41-7.83,17.75-14.5c4.33-6.66,6.5-14.83,6.5-24.5,0-7.33-1.5-14-4.5-20s-7.59-11.25-13.75-15.75c-6.17-4.5-13.92-7.91-23.25-10.25-9.34-2.33-20.34-3.5-33-3.5v-43c23,0,44.08,1.92,63.25,5.75,19.16,3.84,35.91,9.84,50.25,18,14.33,8.17,25.33,18.59,33,31.25,7.66,12.67,11.5,27.84,11.5,45.5,0,20.34-5.5,38.25-16.5,53.75s-26.67,27.67-47,36.5c-20.34,8.83-44.84,13.25-73.5,13.25-21,0-39.84-3.17-56.5-9.5ZM227.75,216.75c9.66,0,18.41-1.25,26.25-3.75,7.83-2.5,14.66-5.91,20.5-10.25,5.83-4.33,10.25-9.33,13.25-15,3-5.66,4.5-11.66,4.5-18,0-6.66-1.5-12.66-4.5-18-3-5.33-7.34-9.41-13-12.25-5.67-2.83-13-4.25-22-4.25-13.34,0-24.34,3.84-33,11.5-8.67,7.67-13,17.67-13,30h-77.5c0-20.66,5.08-39.25,15.25-55.75,10.16-16.5,24.58-29.5,43.25-39,18.66-9.5,40.33-14.25,65-14.25,26.33,0,48.66,4.34,67,13,18.33,8.67,32.25,20.34,41.75,35,9.5,14.67,14.25,31,14.25,49,0,20-6.59,36.67-19.75,50-13.17,13.34-30.92,23.34-53.25,30-22.34,6.67-47.34,10-75,10v-38Z"/>
            </g>
          </g>
        </mask>

        <!-- 変形用パス -->
        <g id="digitTargets" style="display:none">
          <path id="digit-0" d="M122.75,158.91c12.16-27,29.25-47.75,51.25-62.25s47.33-21.75,76-21.75,55.41,7.25,77.25,21.75c21.83,14.5,38.66,35.25,50.5,62.25,11.83,27,17.75,59.5,17.75,97.5s-5.92,70.5-17.75,97.5c-11.84,27-28.67,47.75-50.5,62.25-21.84,14.5-47.59,21.75-77.25,21.75s-54-7.25-76-21.75-39.09-35.25-51.25-62.25c-12.17-27-18.25-59.5-18.25-97.5s6.08-70.5,18.25-97.5ZM190.5,301.16c3,13.5,7.33,25,13,34.5,5.66,9.5,12.41,16.84,20.25,22,7.83,5.17,16.58,7.75,26.25,7.75s18.41-2.58,26.25-7.75c7.83-5.16,14.58-12.5,20.25-22,5.66-9.5,10-21,13-34.5,3-13.5,4.5-28.41,4.5-44.75s-1.5-31.25-4.5-44.75-7.34-25-13-34.5c-5.67-9.5-12.42-16.83-20.25-22-7.84-5.16-16.59-7.75-26.25-7.75s-18.42,2.59-26.25,7.75c-7.84,5.17-14.59,12.5-20.25,22-5.67,9.5-10,21-13,34.5s-4.5,28.42-4.5,44.75,1.5,31.25,4.5,44.75Z"/>
          <path id="digit-1" d="M138,105.75l168-34v356.5h-81.5V157.75l-86.5,21.5v-73.5Z"/>
          <path id="digit-2" d="M242.02,267c9.33-10.33,17.41-19.66,24.25-28,6.83-8.33,12-16.58,15.5-24.75,3.5-8.16,5.25-16.91,5.25-26.25,0-5.33-1-10.66-3-16-2-5.33-5-10.08-9-14.25-4-4.16-9-7.5-15-10s-13-3.75-21-3.75c-10.67,0-20.09,2.67-28.25,8-8.17,5.34-14.34,12.84-18.5,22.5-4.17,9.67-6.25,20.84-6.25,33.5h-83c0-25,5.16-47.83,15.5-68.5,10.33-20.66,25.91-37.16,46.75-49.5,20.83-12.33,46.25-18.5,76.25-18.5,21.66,0,40.83,3.25,57.5,9.75,16.66,6.5,30.58,15.17,41.75,26,11.16,10.84,19.58,22.75,25.25,35.75,5.66,13,8.5,26.17,8.5,39.5,0,19-4.67,36.42-14,52.25-9.34,15.84-21.5,30.25-36.5,43.25l-81.5,73h140v77.5H86.02l156-161.5Z"/>
          <path id="digit-3" d="M192.25,422.75c-16.67-6.33-30.75-15.16-42.25-26.5-11.5-11.33-20.34-24.16-26.5-38.5-6.17-14.33-9.25-29.16-9.25-44.5h83c0,11.34,2.5,20.84,7.5,28.5,5,7.67,11.75,13.34,20.25,17,8.5,3.67,17.41,5.5,26.75,5.5,10,0,18.75-1.5,26.25-4.5s13.41-7.83,17.75-14.5c4.33-6.66,6.5-14.83,6.5-24.5,0-7.33-1.5-14-4.5-20s-7.59-11.25-13.75-15.75c-6.17-4.5-13.92-7.91-23.25-10.25-9.34-2.33-20.34-3.5-33-3.5v-43c23,0,44.08,1.92,63.25,5.75,19.16,3.84,35.91,9.84,50.25,18,14.33,8.17,25.33,18.59,33,31.25,7.66,12.67,11.5,27.84,11.5,45.5,0,20.34-5.5,38.25-16.5,53.75s-26.67,27.67-47,36.5c-20.34,8.83-44.84,13.25-73.5,13.25-21,0-39.84-3.17-56.5-9.5ZM227.75,216.75c9.66,0,18.41-1.25,26.25-3.75,7.83-2.5,14.66-5.91,20.5-10.25,5.83-4.33,10.25-9.33,13.25-15,3-5.66,4.5-11.66,4.5-18,0-6.66-1.5-12.66-4.5-18-3-5.33-7.34-9.41-13-12.25-5.67-2.83-13-4.25-22-4.25-13.34,0-24.34,3.84-33,11.5-8.67,7.67-13,17.67-13,30h-77.5c0-20.66,5.08-39.25,15.25-55.75,10.16-16.5,24.58-29.5,43.25-39,18.66-9.5,40.33-14.25,65-14.25,26.33,0,48.66,4.34,67,13,18.33,8.67,32.25,20.34,41.75,35,9.5,14.67,14.25,31,14.25,49,0,20-6.59,36.67-19.75,50-13.17,13.34-30.92,23.34-53.25,30-22.34,6.67-47.34,10-75,10v-38Z"/>
          <!-- 正円形 -->
          <path id="digit-circle" d="M250 235 A 15 15 0 1 1 250 265 A 15 15 0 1 1 250 235 Z"/>
          <!-- 全面 -->
          <path id="digit-full" d="M0 0 H500 V500 H0 Z"/>
        </g>
      </defs>

      <!-- 計測用の不可視パス（中央合わせに使用） -->
      <path id="bboxMeasure" visibility="hidden" fill="none" stroke="none"/>

      <!-- 背景画像レイヤー（マスク適用） -->
      <image class="photo" x="0" y="0" width="500" height="500" href="https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=2600&q=80" preserveAspectRatio="xMidYMid slice" mask="url(#digitMask)"/>

      <!-- オーバーレイ（コントラスト補正） -->
      <rect width="500" height="500" fill="rgba(0,0,0,.25)"/>
    </svg>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/MorphSVGPlugin.min.js"></script>
  <script>
    gsap.registerPlugin(MorphSVGPlugin);

    const D = 1.0; // アニメの基準秒数
    let reachedFull = false; // 最後まで到達したらリサイズ時の再フィットを停止

    // タイムライン基本設定
    const tl = gsap.timeline({ defaults:{ duration: 1.0, ease:'power4.inOut' } });

    // レスポンシブ対応：画面比に合わせて縮小
    const maskScale = document.getElementById('maskScale');
    function fitDigitsToViewport(margin = 0.9){
      const r = window.innerWidth / window.innerHeight; // 画面アスペクト比
      // xMidYMid slice で実際に見える viewBox 領域（500基準）
      const visibleW = r > 1 ? 500 : 500 * r;
      const visibleH = r > 1 ? 500 / r : 500;
      const s = Math.min(visibleW, visibleH) / 500 * margin; // 0<s<=1, margin は安全余白
      gsap.set(maskScale, { svgOrigin: '250 250', scale: s });
    }
    fitDigitsToViewport();
    addEventListener('resize', () => { if(!reachedFull) fitDigitsToViewport(); });

    // 事前センタリング：各ターゲットパスを(250,250)中心に平行移動
    const measurePath = document.getElementById('bboxMeasure');
    function centerShiftFor(selector){
      const d = document.querySelector(selector).getAttribute('d');
      measurePath.setAttribute('d', d);
      const b = measurePath.getBBox();
      return { x: 250 - (b.x + b.width/2), y: 250 - (b.y + b.height/2) };
    }
    const shifts = {
      'digit-3': centerShiftFor('#digit-3'),
      'digit-2': centerShiftFor('#digit-2'),
      'digit-1': centerShiftFor('#digit-1'),
      'digit-0': centerShiftFor('#digit-0'),
      'digit-circle': centerShiftFor('#digit-circle'),
      'digit-full': centerShiftFor('#digit-full')
    };
    const NUDGE_1 = -10; // 「1」を少し左に寄せる

    // 事前オフセットの適用
    ['digit-3','digit-2','digit-1','digit-0','digit-circle','digit-full'].forEach(id => {
      const el = document.getElementById(id);
      const dx = shifts[id].x + (id === 'digit-1' ? NUDGE_1 : 0);
      const dy = shifts[id].y;
      el.setAttribute('transform', `translate(${dx},${dy})`);
    });

    // 再生シーケンス
    tl
      // 3 → 2
      .addLabel('s2', '+=0.05') // 少し間を空けて開始
      .to('#digitPath', { delay: 0.5, morphSVG:{ shape:'#digit-2', shapeIndex:'auto' } }, 's2')

      // 2 → 1
      .addLabel('s1', '+=0.05')
      .to('#digitPath', { morphSVG:{ shape:'#digit-1', shapeIndex:'auto' } }, 's1')

      // 1 → 0
      .addLabel('s0', '+=0.05')
      .to('#digitPath', { morphSVG:{ shape:'#digit-0', shapeIndex:'auto' } }, 's0')

      // 0 → 小円
      .addLabel('sc', '+=0.5')
      .to('#digitPath', { duration: D*0.6, morphSVG:{ shape:'#digit-circle', shapeIndex:'auto' } }, 'sc')

      // 小円 → 全面
      .addLabel('expand')
      .to('#digitPath', { duration: D*0.8, ease: 'power4.out', morphSVG:{ shape:'#digit-full', shapeIndex:'auto' } }, 'expand')
      .to('#maskScale', { duration: D*0.8, ease: 'power4.out', scale: 1 }, 'expand') // スケールも1に戻す
      .add(() => { reachedFull = true; });
    
  </script>
</body>
</html>